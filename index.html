<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Merced County 511 Prototype — USGS Added</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100%; }
    .panel { position:absolute; top:10px; left:10px; z-index:10; background:color-mix(in oklab, Canvas, CanvasText 10%/70%); backdrop-filter: blur(6px); padding:10px; border-radius:12px; font: 13px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; box-shadow: 0 4px 12px rgba(0,0,0,.15); max-width: 310px; }
    .panel h3 { margin:.25rem 0 .5rem; font-size:14px; }
    .row { display:flex; align-items:center; gap:.4rem; margin:.25rem 0; }
    .ctrl-btn { padding: 6px 10px; }
    label { user-select:none; }
    .legend { display:flex; flex-wrap:wrap; gap:.4rem .6rem; margin-top:.25rem; }
    .k { width:10px;height:10px;border-radius:2px;display:inline-block;margin-right:.3rem;vertical-align:middle;}
    .popup-list { max-width: 320px;}
    .popup-list button { display:block; width:100%; text-align:left; margin:.25rem 0; padding:.4rem .5rem; border-radius:8px; border:1px solid color-mix(in oklab, CanvasText 30%, transparent); background:color-mix(in oklab, Canvas, CanvasText 6%/60%); cursor:pointer; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Layer toggles -->
  <div class="panel">
    <h3>Layers</h3>
    <div class="row"><input type="checkbox" id="chk-cctv" checked><label for="chk-cctv">CCTV (GeoJSON)</label></div>
    <div class="row"><input type="checkbox" id="chk-chp" checked><label for="chk-chp">CHP Incidents (KML via Worker)</label></div>
    <div class="row"><input type="checkbox" id="chk-lcs" checked><label for="chk-lcs">Lane Closures (KML via Worker)</label></div>
    <div class="row"><input type="checkbox" id="chk-cms" checked><label for="chk-cms">CMS Signs (KML via Worker)</label></div>
    <hr>
    <div class="row"><input type="checkbox" id="chk-nws" checked><label for="chk-nws">NWS Alerts (polygons)</label></div>
    <div class="row"><input type="checkbox" id="chk-fog" checked><label for="chk-fog">Dense Fog Advisories</label></div>
    <div class="row"><input type="checkbox" id="chk-metar" checked><label for="chk-metar">Visibility (METAR, mi)</label></div>
    <div class="row"><input type="checkbox" id="chk-usgs" checked><label for="chk-usgs">USGS Streamgages (stage & flow)</label></div>
    <div class="legend">
      <span><i class="k" style="background:#10b981"></i>CCTV</span>
      <span><i class="k" style="background:#6366f1"></i>CMS</span>
      <span><i class="k" style="background:#f59e0b"></i>CHP</span>
      <span><i class="k" style="background:#dc2626"></i>LCS</span>
      <span><i class="k" style="background:#1f2937"></i>Fog</span>
      <span><i class="k" style="background:#14b8a6"></i>USGS</span>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
  <!-- KML → GeoJSON (UMD: window.toGeoJSON) -->
  <script src="https://unpkg.com/@tmcw/togeojson@7.1.2/dist/togeojson.umd.js"></script>

  <script>
    // =====================
    // 1) CONFIG
    // =====================
    const WORKER = 'https://restless-dream-d169.windman007.workers.dev';

    // ArcGIS CCTV FeatureServer (GeoJSON works cross-origin)
    const CCTV_URL = (
      'https://caltrans-gis.dot.ca.gov/arcgis/rest/services/CHhighway/CCTV/FeatureServer/0/query'
      + '?where=' + encodeURIComponent("county IN ('Merced','Stanislaus','Madera','Mariposa')")
      + '&outFields=' + encodeURIComponent('OBJECTID,locationName,currentImageURL,county,route,latitude,longitude')
      + '&returnGeometry=true&f=geojson'
    );

    // QuickMap KML endpoints (proxied through WORKER)
    const QK = {
      chp: `${WORKER}/?src=${encodeURIComponent('https://quickmap.dot.ca.gov/data/chp-only.kml')}`,
      lcs: `${WORKER}/?src=${encodeURIComponent('https://quickmap.dot.ca.gov/data/lcs2way.kml')}`,
      cms: `${WORKER}/?src=${encodeURIComponent('https://quickmap.dot.ca.gov/data/cms.kml')}`
    };

    // NWS APIs (public domain)
    const NWS_ALERTS_BASE = 'https://api.weather.gov/alerts';
    const NWS_STATIONS = 'https://api.weather.gov/stations';

    // USGS NWIS (public domain)
    const USGS_IV = 'https://waterservices.usgs.gov/nwis/iv/';

    // Bounds / view
    const MERCED_CENTER = [-120.48, 37.30];
    const VIEW_BOUNDS = [[-122.30, 36.60], [-119.00, 37.90]]; // [W,S],[E,N]

    // =====================
    // 2) MAP
    // =====================
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json',
      center: MERCED_CENTER,
      zoom: 9,
      minZoom: 7.8,
      maxZoom: 18,
      maxBounds: VIEW_BOUNDS,
      attributionControl: true
    });

    map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'top-right');
    map.addControl(new maplibregl.ScaleControl({ unit: 'imperial' }));
    map.dragRotate.disable();
    map.touchZoomRotate.disableRotation();

    map.on('error', e => console.error('Map error:', e && e.error || e));

    map.on('load', () => {
      map.fitBounds(VIEW_BOUNDS, { padding: 40, duration: 0 });

      // County context
      map.addSource('ca-counties', {
        type: 'geojson',
        data: 'https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/california-counties.geojson'
      });
      map.addLayer({ id: 'county-fill', type: 'fill', source: 'ca-counties', paint: { 'fill-color': '#6b7280', 'fill-opacity': 0.07 } });
      map.addLayer({ id: 'county-outline', type: 'line', source: 'ca-counties', paint: { 'line-color': '#222', 'line-width': 1.5, 'line-opacity': 0.9 } });
      map.addLayer({ id: 'merced-highlight', type: 'line', source: 'ca-counties', filter: ['match', ['get', 'name'], ['Merced', 'Merced County'], true, false], paint: { 'line-color': '#0ea5e9', 'line-width': 3 } });

      // Basemaps (OSM streets + Esri satellite)
      map.addSource('osm', { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256, attribution: '© OpenStreetMap contributors' });
      map.addLayer({ id: 'osm', type: 'raster', source: 'osm' });
      map.addSource('esri', { type: 'raster', tiles: ['https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256, attribution: 'Esri, Maxar, Earthstar Geographics, and the GIS User Community' });
      map.addLayer({ id: 'satellite', type: 'raster', source: 'esri', layout: { visibility: 'none' } });

      // =====================
      // 3) DATA LAYERS (clustered + generic click picker)
      // =====================
      async function addCctv() {
        try {
          const resp = await fetch(CCTV_URL, { cache: 'no-store' });
          if (!resp.ok) throw new Error(`CCTV HTTP ${resp.status}`);
          const data = await resp.json();
          for (const f of (data.features || [])) {
            const p = f.properties || {};
            if (typeof p.currentImageURL === 'string' && p.currentImageURL.startsWith('http:')) {
              p.currentImageURL = p.currentImageURL.replace(/^http:/, 'https:');
            }
          }
          const src = 'cctv-src';
          if (map.getSource(src)) map.removeSource(src);
          map.addSource(src, { type: 'geojson', data, cluster: true, clusterRadius: 40, clusterProperties: {} });

          // clusters
          map.addLayer({ id: 'cctv-clusters', type: 'circle', source: src, filter: ['has', 'point_count'], paint: { 'circle-color': '#0ea5e9', 'circle-radius': ['interpolate', ['linear'], ['get', 'point_count'], 2, 12, 100, 22], 'circle-stroke-color':'#fff', 'circle-stroke-width':1 } });
          map.addLayer({ id: 'cctv-count', type: 'symbol', source: src, filter: ['has', 'point_count'], layout: { 'text-field': ['get', 'point_count_abbreviated'], 'text-size': 12 }, paint: { 'text-color':'#fff' } });

          // unclustered points
          map.addLayer({ id: 'cctv-lyr', type: 'circle', source: src, filter: ['!', ['has', 'point_count']], paint: { 'circle-radius': ["interpolate", ["linear"], ["zoom"], 6, 3, 10, 5, 14, 8], 'circle-color': '#10b981', 'circle-stroke-width': 1, 'circle-stroke-color': '#fff' } });
        } catch (err) { console.error('CCTV load failed:', err); }
      }

      async function addKmlLayer(kmlUrl, id, color, asLine=false) {
        try {
          const resp = await fetch(kmlUrl, { cache: 'no-store' });
          if (!resp.ok) throw new Error(`KML HTTP ${resp.status}`);
          const text = await resp.text();
          const xml = new DOMParser().parseFromString(text, 'text/xml');
          const gj = window.toGeoJSON.kml(xml);
          const src = `${id}-src`;
          if (map.getSource(src)) map.removeSource(src);
          map.addSource(src, { type: 'geojson', data: gj, cluster: !asLine, clusterRadius: 40 });

          if (asLine) {
            map.addLayer({ id: `${id}-lyr`, type: 'line', source: src, paint: { 'line-color': color, 'line-width': 3, 'line-opacity': 0.8 } });
          } else {
            map.addLayer({ id: `${id}-clusters`, type: 'circle', source: src, filter: ['has', 'point_count'], paint: { 'circle-color': color, 'circle-opacity': .9, 'circle-radius': ['interpolate', ['linear'], ['get', 'point_count'], 2, 12, 100, 22], 'circle-stroke-color':'#fff', 'circle-stroke-width':1 } });
            map.addLayer({ id: `${id}-count`, type: 'symbol', source: src, filter: ['has', 'point_count'], layout: { 'text-field': ['get', 'point_count_abbreviated'], 'text-size': 12 }, paint: { 'text-color':'#fff' } });
            map.addLayer({ id: `${id}-lyr`, type: 'circle', source: src, filter: ['!', ['has', 'point_count']], paint: { 'circle-radius': ["interpolate", ["linear"], ["zoom"], 6, 3, 10, 5, 14, 8], 'circle-color': color, 'circle-stroke-width': 1, 'circle-stroke-color': '#fff' } });
          }
        } catch (err) { console.error('KML load failed for', id, err); }
      }

      // ---- NWS Alerts (all) + dense fog subset
      async function addNwsAlerts() {
        const bbox = VIEW_BOUNDS.flat().join(','); // west,south,east,north
        const url = `${NWS_ALERTS_BASE}?status=actual&message_type=alert&bbox=${bbox}`;
        try {
          const resp = await fetch(url, { headers: { 'Accept': 'application/geo+json' }, cache: 'no-store' });
          if (!resp.ok) throw new Error(`NWS alerts HTTP ${resp.status}`);
          const gj = await resp.json();
          const src = 'nws-alerts-src';
          if (map.getSource(src)) map.removeSource(src);
          map.addSource(src, { type: 'geojson', data: gj });

          // Polygons
          map.addLayer({ id: 'nws-alerts-fill', type: 'fill', source: src, paint: { 'fill-color': ['match', ['get','event'], 'Dense Fog Advisory', '#111827', 'Flood Warning', '#86198f', 'Flood Advisory', '#a21caf', 'Flash Flood Warning', '#7c3aed', /* other */ '#6b7280' ], 'fill-opacity': 0.25 } });
          map.addLayer({ id: 'nws-alerts-outline', type: 'line', source: src, paint: { 'line-color': ['match', ['get','event'], 'Dense Fog Advisory', '#111827', 'Flood Warning', '#86198f', 'Flood Advisory', '#a21caf', 'Flash Flood Warning', '#7c3aed', '#6b7280' ], 'line-width': 1.5, 'line-opacity': 0.9 } });

          // Dense Fog label subset
          map.addLayer({ id: 'fog-lyr', type: 'symbol', source: src, filter: ['==', ['get','event'], 'Dense Fog Advisory'], layout: { 'text-field': 'Fog Adv.', 'text-size': 12, 'text-offset': [0,1] }, paint: { 'text-color':'#111827' } });
        } catch (e) { console.error('NWS alerts failed', e); }
      }

      // ---- METAR latest visibility points from nearby stations
      async function addMetarVisibility() {
        try {
          const [w,s] = VIEW_BOUNDS[0]; const [e,n] = VIEW_BOUNDS[1];
          const listResp = await fetch(`${NWS_STATIONS}?bbox=${w},${s},${e},${n}`, { cache:'no-store' });
          if (!listResp.ok) throw new Error('Stations list error');
          const list = await listResp.json();
          const feats = list.features || [];
          const batches = [];
          for (const st of feats) {
            const id = st.properties.stationIdentifier;
            const [lng, lat] = st.geometry.coordinates;
            if (!id) continue;
            batches.push(fetch(`${NWS_STATIONS}/${id}/observations/latest`, { cache:'no-store' }).then(r => r.ok ? r.json() : null).then(o => {
              if (!o || !o.properties) return null;
              const visM = o.properties.visibility && o.properties.visibility.value; // meters
              const cond = o.properties.textDescription || '';
              if (visM == null) return null;
              const visMi = visM/1609.344;
              return { type:'Feature', geometry:{ type:'Point', coordinates:[lng, lat] }, properties:{ id, visMi, cond, raw:o.properties.rawMessage || '', time:o.properties.timestamp } };
            }).catch(() => null));
          }
          const results = (await Promise.all(batches)).filter(Boolean);
          const gj = { type:'FeatureCollection', features: results };
          const src = 'metar-vis-src';
          if (map.getSource(src)) map.removeSource(src);
          map.addSource(src, { type:'geojson', data: gj });
          map.addLayer({ id: 'metar-vis-lyr', type: 'symbol', source: src, layout: { 'text-field': ['concat', ['to-string', ['round', ['get','visMi'] ]], ' mi'], 'text-size': 12, 'text-offset':[0, -1] }, paint: { 'text-halo-color':'#fff', 'text-halo-width':1, 'text-color':'#0f172a' } });
        } catch (e) { console.error('METAR visibility failed', e); }
      }

      // ---- USGS NWIS real-time streamgages (stage & discharge)
      async function addUsgsGages() {
        try {
          const [w,s] = VIEW_BOUNDS[0]; const [e,n] = VIEW_BOUNDS[1];
          const params = new URLSearchParams({
            format: 'json',
            parameterCd: '00065,00060', // 00065=gauge height, 00060=discharge
            bBox: `${w},${s},${e},${n}`,
            siteStatus: 'active'
          });
          const url = `${USGS_IV}?${params.toString()}`;
          const resp = await fetch(url, { cache: 'no-store' });
          if (!resp.ok) throw new Error('USGS IV HTTP ' + resp.status);
          const iv = await resp.json();

          const sites = new Map();
          for (const ts of (iv.value?.timeSeries || [])) {
            const site = ts.sourceInfo?.siteCode?.[0]?.value;
            const name = ts.sourceInfo?.siteName;
            const coords = ts.sourceInfo?.geoLocation?.geogLocation;
            const parm = ts.variable?.variableCode?.[0]?.value; // '00065' or '00060'
            const val = ts.values?.[0]?.value?.[0];
            if (!site || !coords || !val) continue;
            if (!sites.has(site)) sites.set(site, { site, name, lng: +coords.longitude, lat: +coords.latitude, stage_ft: null, flow_cfs: null, time: val.dateTime });
            const rec = sites.get(site);
            if (parm === '00065') { rec.stage_ft = parseFloat(val.value); rec.time = val.dateTime || rec.time; }
            if (parm === '00060') { rec.flow_cfs = parseFloat(val.value); rec.time = val.dateTime || rec.time; }
          }

          const features = Array.from(sites.values()).map(r => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [r.lng, r.lat] },
            properties: { site: r.site, name: r.name, stage_ft: r.stage_ft, flow_cfs: r.flow_cfs, time: r.time, url: `https://waterdata.usgs.gov/monitoring-location/${r.site}/#parameterCode=00065&period=P7D` }
          }));

          const gj = { type: 'FeatureCollection', features };
          const src = 'usgs-src';
          if (map.getSource(src)) map.removeSource(src);
          map.addSource(src, { type: 'geojson', data: gj, cluster: true, clusterRadius: 40 });

          map.addLayer({ id: 'usgs-clusters', type: 'circle', source: src, filter: ['has','point_count'], paint: { 'circle-color': '#14b8a6', 'circle-radius': ['interpolate',['linear'],['get','point_count'], 2, 12, 100, 22], 'circle-stroke-color':'#fff', 'circle-stroke-width':1 } });
          map.addLayer({ id: 'usgs-count', type: 'symbol', source: src, filter: ['has','point_count'], layout: { 'text-field': ['get','point_count_abbreviated'], 'text-size': 12 }, paint: { 'text-color': '#fff' } });

          map.addLayer({ id: 'usgs-lyr', type: 'circle', source: src, filter: ['!', ['has','point_count']], paint: {
            'circle-radius': ["interpolate", ["linear"], ["zoom"], 6, 3, 10, 5, 14, 8],
            'circle-color': [ 'interpolate', ['linear'], ['coalesce', ['get','flow_cfs'], 0], 0, '#a7f3d0', 100, '#34d399', 1000, '#10b981', 5000, '#047857' ],
            'circle-stroke-width': 1, 'circle-stroke-color': '#fff'
          }});
        } catch (e) { console.error('USGS gages failed', e); }
      }

      // Load initial layers
      addCctv();
      addKmlLayer(QK.chp, 'chp', '#f59e0b', false);
      addKmlLayer(QK.lcs, 'lcs', '#dc2626', true);
      addKmlLayer(QK.cms, 'cms', '#6366f1', false);
      addNwsAlerts();
      addMetarVisibility();
      addUsgsGages();

      // =====================
      // 4) TOGGLES
      // =====================
      const toggles = [
        { chk: 'chk-cctv', layers: ['cctv-clusters','cctv-count','cctv-lyr'], loader: addCctv },
        { chk: 'chk-chp',  layers: ['chp-clusters','chp-count','chp-lyr'], loader: () => addKmlLayer(QK.chp, 'chp', '#f59e0b') },
        { chk: 'chk-lcs',  layers: ['lcs-lyr'], loader: () => addKmlLayer(QK.lcs, 'lcs', '#dc2626', true) },
        { chk: 'chk-cms',  layers: ['cms-clusters','cms-count','cms-lyr'], loader: () => addKmlLayer(QK.cms, 'cms', '#6366f1') },
        { chk: 'chk-nws',  layers: ['nws-alerts-fill','nws-alerts-outline'], loader: addNwsAlerts },
        { chk: 'chk-fog',  layers: ['fog-lyr'], loader: addNwsAlerts },
        { chk: 'chk-metar', layers: ['metar-vis-lyr'], loader: addMetarVisibility },
        { chk: 'chk-usgs', layers: ['usgs-clusters','usgs-count','usgs-lyr'], loader: addUsgsGages },
      ];
      for (const t of toggles) {
        const el = document.getElementById(t.chk);
        el?.addEventListener('change', () => {
          const visible = el.checked;
          const haveAny = t.layers.some(id => map.getLayer(id));
          if (!haveAny && visible) { t.loader(); return; }
          for (const id of t.layers) if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', visible ? 'visible' : 'none');
        });
      }

      // =====================
      // 5) OVERLAP HANDLING — click picker
      // =====================
      const CLICK_LAYERS = ['cctv-lyr','cms-lyr','chp-lyr','lcs-lyr','nws-alerts-fill','fog-lyr','metar-vis-lyr','usgs-lyr'];

      function htmlForFeature(f) {
        const id = f.layer?.id || '';
        const p = f.properties || {};
        if (id === 'cctv-lyr') {
          const url = p.currentImageURL || '';
          return `<div><strong>${p.locationName || 'Camera'}</strong><br>Route: ${p.route ?? '—'}<br>County: ${p.county ?? '—'}${url ? `<div style='margin-top:6px'><img src='${url}' style='max-width:320px;max-height:240px;border-radius:8px'></div>` : ''}</div>`;
        }
        if (id === 'cms-lyr' || id === 'chp-lyr') {
          const title = p.name || p.Title || (id.startsWith('cms') ? 'CMS Sign' : 'CHP');
          const desc = p.description || p.Description || '<em>No details</em>';
          return `<div><strong>${title}</strong><div style='max-width:320px;'>${desc}</div></div>`;
        }
        if (id === 'lcs-lyr') {
          const title = p.name || p.Title || 'Lane Closure';
          const desc = p.description || p.Description || '<em>No details</em>';
          return `<div><strong>${title}</strong><div style='max-width:320px;'>${desc}</div>`;
        }
        if (id === 'nws-alerts-fill' || id === 'fog-lyr') {
          const evt = p.event || 'NWS Alert';
          const headline = p.headline || '';
          const eff = p.effective || '';
          const exp = p.expires || '';
          return `<div><strong>${evt}</strong><div>${headline}</div><div><small>${eff} → ${exp}</small></div></div>`;
        }
        if (id === 'metar-vis-lyr') {
          return `<div><strong>Visibility</strong><br>${Number(p.visMi).toFixed(1)} mi — ${p.cond || ''}<br><small>${p.id} • ${new Date(p.time).toLocaleString()}</small><br><pre style='white-space:pre-wrap'>${p.raw || ''}</pre></div>`;
        }
        if (id === 'usgs-lyr') {
          const u = p.url ? `<a href='${p.url}' target='_blank' rel='noopener'>Open USGS site</a>` : '';
          return `<div><strong>${p.name || 'USGS Gage'}</strong><br>Site: ${p.site || ''}<br>Stage: ${p.stage_ft != null ? Number(p.stage_ft).toFixed(2) + ' ft' : '—'}<br>Flow: ${p.flow_cfs != null ? Math.round(p.flow_cfs) + ' cfs' : '—'}<br><small>${p.time ? new Date(p.time).toLocaleString() : ''}</small><div style='margin-top:6px'>${u}</div></div>`;
        }
        return '<em>Feature</em>';
      }

      function titleForFeature(f) {
        const id = f.layer?.id || '';
        const p = f.properties || {};
        if (id === 'cctv-lyr') return `CCTV — ${p.locationName || 'Camera'}`;
        if (id === 'cms-lyr') return `CMS — ${p.name || 'Sign'}`;
        if (id === 'chp-lyr') return `CHP — ${p.name || 'Incident'}`;
        if (id === 'lcs-lyr') return `LCS — ${p.name || 'Closure'}`;
        if (id === 'nws-alerts-fill' || id === 'fog-lyr') return `NWS — ${p.event || 'Alert'}`;
        if (id === 'metar-vis-lyr') return `METAR — ${p.id || 'Station'}`;
        if (id === 'usgs-lyr') return `USGS — ${p.name || p.site || 'Gage'}`;
        return 'Feature';
      }

      function showPopupForFeature(f, lngLat) {
        new maplibregl.Popup({ maxWidth: '360px' })
          .setLngLat(lngLat)
          .setHTML(htmlForFeature(f))
          .addTo(map);
      }

      map.on('click', (e) => {
        const radius = 8; // px search radius
        const feats = map.queryRenderedFeatures([[e.point.x - radius, e.point.y - radius],[e.point.x + radius, e.point.y + radius]], { layers: CLICK_LAYERS.filter(id => map.getLayer(id)) });
        if (!feats.length) return;
        const cl = feats.find(f => /-clusters$/.test(f.layer.id));
        if (cl && map.getSource(cl.layer.source).type === 'geojson') {
          const src = map.getSource(cl.layer.source);
          src.getClusterExpansionZoom(cl.properties.cluster_id, (err, zoom) => {
            if (err) return console.warn(err);
            map.easeTo({ center: e.lngLat, zoom });
          });
          return;
        }
        const pointFeats = feats.filter(f => !/-clusters$/.test(f.layer.id) && f.geometry.type === 'Point' || f.layer.id === 'lcs-lyr' || f.layer.id === 'nws-alerts-fill' || f.layer.id === 'fog-lyr');
        if (pointFeats.length === 1) { showPopupForFeature(pointFeats[0], e.lngLat); return; }
        const items = pointFeats.slice(0, 8).map((f, i) => `<button data-idx="${i}">${titleForFeature(f)}</button>`).join('');
        const container = document.createElement('div');
        container.className = 'popup-list';
        container.innerHTML = `<strong>Choose an item here:</strong>${items}`;
        const pop = new maplibregl.Popup({ maxWidth: '360px' }).setLngLat(e.lngLat).setDOMContent(container).addTo(map);
        container.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', () => {
            const i = +btn.getAttribute('data-idx');
            pop.remove();
            showPopupForFeature(pointFeats[i], e.lngLat);
          });
        });
      });

    }); // end load

    // Basemap toggle button
    (function addBasemapToggle(){
      const btn = document.createElement('button');
      btn.textContent = 'Satellite';
      btn.className = 'maplibregl-ctrl maplibregl-ctrl-group ctrl-btn';
      btn.onclick = () => {
        const isSat = map.getLayoutProperty('satellite', 'visibility') !== 'none';
        map.setLayoutProperty('satellite', 'visibility', isSat ? 'none' : 'visible');
        map.setLayoutProperty('osm', 'visibility', isSat ? 'visible' : 'none');
        btn.textContent = isSat ? 'Satellite' : 'Streets';
      };
      const corner = document.querySelector('.maplibregl-ctrl-top-right') || document.body;
      const wrap = document.createElement('div');
      wrap.className = 'maplibregl-ctrl maplibregl-ctrl-group';
      wrap.appendChild(btn);
      corner.appendChild(wrap);
    })();

    // Home button
    (function addHome(){
      const btn = document.createElement('button');
      btn.textContent = 'Home';
      btn.className = 'maplibregl-ctrl maplibregl-ctrl-group ctrl-btn';
      btn.onclick = () => map.fitBounds(VIEW_BOUNDS, { padding: 40, duration: 500 });
      const corner = document.querySelector('.maplibregl-ctrl-top-right') || document.body;
      const wrap = document.createElement('div');
      wrap.className = 'maplibregl-ctrl maplibregl-ctrl-group';
      wrap.appendChild(btn);
      corner.appendChild(wrap);
    })();
  </script>
</body>
</html>
