<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Merced County 511 Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100%; }
    .ctrl-btn { padding: 6px 10px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
  <script>
    // --------- CONFIG ---------
    const MERCED_CENTER = [-120.48, 37.30];
    // Constrain users to Merced + nearby counties
    const VIEW_BOUNDS = [
      [-123.35, 36.60], // [W, S]
      [-119.30, 37.90]  // [E, N]
    ];

    // --------- MAP ---------
    // Use a known-good base style so you immediately see roads/labels
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json',
      center: MERCED_CENTER,
      zoom: 9,
      minZoom: 7.5,                   // prevent zooming out to the globe
      maxZoom: 18,
      maxBounds: VIEW_BOUNDS,         // hard bounds box
      attributionControl: true
    });

    map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'top-right');
    map.addControl(new maplibregl.ScaleControl({ unit: 'imperial' }));
    map.dragRotate.disable();
    map.touchZoomRotate.disableRotation();

    // Log any style or tile errors to help debugging on GH Pages
    map.on('error', (e) => { console.error('Map error:', e && e.error || e); });

    map.on('load', () => {
      // Ensure we start within our allowed box
      map.fitBounds(VIEW_BOUNDS, { padding: 40, duration: 0 });

      // ---- Satellite raster (Esri) ----
      map.addSource('satellite-src', {
        type: 'raster',
        tiles: ['https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
        tileSize: 256,
        attribution: 'Esri, Maxar, Earthstar Geographics, and the GIS User Community'
      });
      // Put satellite beneath labels/roads. If a reference layer exists, insert before it.
      const beforeId = map.getStyle().layers.find(l => /label/i.test(l.id))?.id;
      map.addLayer({ id: 'satellite', type: 'raster', source: 'satellite-src', layout: { visibility: 'none' } }, beforeId);

      // ---- Streets raster (OSM) — optional extra sanity layer under everything ----
      map.addSource('osm-src', {
        type: 'raster',
        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
        tileSize: 256,
        attribution: '© OpenStreetMap contributors'
      });
      map.addLayer({ id: 'osm-raster', type: 'raster', source: 'osm-src', layout: { visibility: 'visible' } }, 'satellite');

      // ---- California counties overlay ----
      map.addSource('ca-counties', {
        type: 'geojson',
        data: 'https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/california-counties.geojson'
      });

      // Filled polygons (very subtle)
      map.addLayer({
        id: 'county-fill',
        type: 'fill',
        source: 'ca-counties',
        paint: {
          'fill-color': '#6b7280',
          'fill-opacity': 0.07
        }
      });

      // County outlines on top
      map.addLayer({
        id: 'county-outline',
        type: 'line',
        source: 'ca-counties',
        paint: {
          'line-color': '#222',
          'line-width': 1.5,
          'line-opacity': 0.9
        }
      });

      // Bold highlight for Merced (match either name string)
      map.addLayer({
        id: 'merced-highlight',
        type: 'line',
        source: 'ca-counties',
        filter: ['match', ['get', 'name'], ['Merced', 'Merced County'], true, false],
        paint: {
          'line-color': '#0ea5e9',
          'line-width': 3
        }
      });
    });

    // ---- Basemap toggle (Streets ↔ Satellite) ----
    (function addBasemapToggle(){
      const btn = document.createElement('button');
      btn.textContent = 'Satellite';
      btn.className = 'maplibregl-ctrl maplibregl-ctrl-group ctrl-btn';
      btn.onclick = () => {
        const visible = map.getLayoutProperty('satellite', 'visibility') !== 'none';
        map.setLayoutProperty('satellite', 'visibility', visible ? 'none' : 'visible');
        map.setLayoutProperty('osm-raster', 'visibility', visible ? 'visible' : 'none');
        btn.textContent = visible ? 'Satellite' : 'Streets';
      };
      const corner = document.querySelector('.maplibregl-ctrl-top-right') || document.body;
      const wrap = document.createElement('div');
      wrap.className = 'maplibregl-ctrl maplibregl-ctrl-group';
      wrap.appendChild(btn);
      corner.appendChild(wrap);
    })();

    // ---- Home button: refit to bounds ----
    (function addHome(){
      const btn = document.createElement('button');
      btn.textContent = 'Home';
      btn.className = 'maplibregl-ctrl maplibregl-ctrl-group ctrl-btn';
      btn.onclick = () => map.fitBounds(VIEW_BOUNDS, { padding: 40, duration: 400 });
      const corner = document.querySelector('.maplibregl-ctrl-top-right') || document.body;
      const wrap = document.createElement('div');
      wrap.className = 'maplibregl-ctrl maplibregl-ctrl-group';
      wrap.appendChild(btn);
      corner.appendChild(wrap);
    })();
  </script>
</body>
</html>
