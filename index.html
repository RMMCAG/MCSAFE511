<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Merced County 511 Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100%; }
    .ctrl-btn { padding: 6px 10px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
  <!-- KML → GeoJSON (UMD: window.toGeoJSON) -->
  <script src="https://unpkg.com/@tmcw/togeojson@7.1.2/dist/togeojson.umd.js"></script>

  <script>
    // --------- CONFIG ---------
    const MERCED_CENTER = [-120.48, 37.30];
    // Constrain users to Merced + nearby counties  [west,south],[east,north]
    const VIEW_BOUNDS = [[-121.35, 36.60], [-119.30, 37.90]];

    // --------- MAP ---------
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json',
      center: MERCED_CENTER,
      zoom: 9,
      minZoom: 7.8,                 // prevent zooming out to the globe
      maxZoom: 18,
      maxBounds: VIEW_BOUNDS,       // hard panning/zooming bounds
      attributionControl: true
    });

    map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'top-right');
    map.addControl(new maplibregl.ScaleControl({ unit: 'imperial' }));
    map.dragRotate.disable();
    map.touchZoomRotate.disableRotation();

    // Log errors to help diagnose CORS/network issues on GH Pages
    map.on('error', (e) => console.error('Map error:', e && e.error || e));

    map.on('load', () => {
      // Keep initial view inside the allowed box
      map.fitBounds(VIEW_BOUNDS, { padding: 40, duration: 0 });

      // ---- Basemaps ----
      map.addSource('osm', {
        type: 'raster',
        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
        tileSize: 256,
        attribution: '© OpenStreetMap contributors'
      });
      map.addLayer({ id: 'osm', type: 'raster', source: 'osm' });

      map.addSource('esri', {
        type: 'raster',
        tiles: ['https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
        tileSize: 256,
        attribution: 'Esri, Maxar, Earthstar Geographics, and the GIS User Community'
      });
      map.addLayer({ id: 'satellite', type: 'raster', source: 'esri', layout: { visibility: 'none' } });

      // ---- California counties (for context) ----
      map.addSource('ca-counties', {
        type: 'geojson',
        data: 'https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/california-counties.geojson'
      });
      map.addLayer({ id: 'county-fill', type: 'fill', source: 'ca-counties',
        paint: { 'fill-color': '#6b7280', 'fill-opacity': 0.07 } });
      map.addLayer({ id: 'county-outline', type: 'line', source: 'ca-counties',
        paint: { 'line-color': '#222', 'line-width': 1.5, 'line-opacity': 0.9 } });
      map.addLayer({ id: 'merced-highlight', type: 'line', source: 'ca-counties',
        filter: ['match', ['get', 'name'], ['Merced', 'Merced County'], true, false],
        paint: { 'line-color': '#0ea5e9', 'line-width': 3 } });

      // ---- QUICKMAP LAYERS (KML -> GeoJSON) ----
      const QK = {
        chp: 'https://quickmap.dot.ca.gov/data/chp-only.kml',     // CHP incidents
        lcs: 'https://quickmap.dot.ca.gov/data/lcs2way.kml',      // lane closures
        cms: 'https://quickmap.dot.ca.gov/data/cms.kml',          // message signs
        cctv: 'https://quickmap.dot.ca.gov/data/cctv.kml',        // traffic cameras
        chain: 'https://quickmap.dot.ca.gov/data/cc.kml'          // chain controls
      };

      async function addKmlAsGeoJSON(url, id, layerType = 'circle', paint = {}) {
        try {
          const resp = await fetch(url, { cache: 'no-store' });
          const text = await resp.text();
          const xml = new DOMParser().parseFromString(text, 'text/xml');
          const gj = window.toGeoJSON.kml(xml);

          // Clip to our bounding box (points only; keep lines for closures)
          const [[w,s],[e,n]] = VIEW_BOUNDS;
          const data = {
            type: 'FeatureCollection',
            features: (gj.features || []).filter(f => {
              const g = f.geometry; if (!g) return false;
              if (g.type === 'Point') {
                const [x,y] = g.coordinates; return x>=w && x<=e && y>=s && y<=n;
              }
              return true;
            })
          };

          const srcId = `${id}-src`;
          if (map.getLayer(`${id}-lyr`)) map.removeLayer(`${id}-lyr`);
          if (map.getSource(srcId)) map.removeSource(srcId);
          map.addSource(srcId, { type: 'geojson', data });

          if (layerType === 'line') {
            map.addLayer({ id: `${id}-lyr`, type: 'line', source: srcId, paint });
          } else {
            map.addLayer({
              id: `${id}-lyr`,
              type: 'circle',
              source: srcId,
              paint: Object.assign({
                'circle-radius': 5,
                'circle-color': '#ef4444',
                'circle-stroke-width': 1,
                'circle-stroke-color': '#fff'
              }, paint)
            });
          }
        } catch (err) {
          console.error('QuickMap layer failed:', id, err);
        }
      }

      // Load layers
      addKmlAsGeoJSON(QK.chp,   'chp',   'circle', { 'circle-color': '#f59e0b' });
      addKmlAsGeoJSON(QK.cms,   'cms',   'circle', { 'circle-color': '#6366f1' });
      addKmlAsGeoJSON(QK.cctv,  'cctv',  'circle', { 'circle-color': '#10b981' });
      addKmlAsGeoJSON(QK.lcs,   'lcs',   'line',   { 'line-color': '#dc2626', 'line-width': 3, 'line-opacity': 0.8 });
      addKmlAsGeoJSON(QK.chain, 'chain', 'circle', { 'circle-color': '#0ea5e9' });
    });

    // ---- Basemap toggle (Streets ↔ Satellite) ----
    (function addBasemapToggle(){
      const btn = document.createElement('button');
      btn.textContent = 'Satellite';
      btn.className = 'maplibregl-ctrl maplibregl-ctrl-group ctrl-btn';
      btn.onclick = () => {
        const isSat = map.getLayoutProperty('satellite', 'visibility') !== 'none';
        map.setLayoutProperty('satellite', 'visibility', isSat ? 'none' : 'visible');
        map.setLayoutProperty('osm', 'visibility', isSat ? 'visible' : 'none');
        btn.textContent = isSat ? 'Satellite' : 'Streets';
      };
      const corner = document.querySelector('.maplibregl-ctrl-top-right') || document.body;
      const wrap = document.createElement('div');
      wrap.className = 'maplibregl-ctrl maplibregl-ctrl-group';
      wrap.appendChild(btn);
      corner.appendChild(wrap);
    })();

    // ---- Home + Refresh controls ----
    (function addHome(){
      const btn = document.createElement('button');
      btn.textContent = 'Home';
      btn.className = 'maplibregl-ctrl maplibregl-ctrl-group ctrl-btn';
      btn.onclick = () => map.fitBounds(VIEW_BOUNDS, { padding: 40, duration: 500 });
      const corner = document.querySelector('.maplibregl-ctrl-top-right') || document.body;
      const wrap = document.createElement('div');
      wrap.className = 'maplibregl-ctrl maplibregl-ctrl-group';
      wrap.appendChild(btn);
      corner.appendChild(wrap);
    })();

    (function addRefresh(){
      const btn = document.createElement('button');
      btn.textContent = 'Refresh';
      btn.className = 'maplibregl-ctrl maplibregl-ctrl-group ctrl-btn';
      btn.onclick = () => location.reload();
      const corner = document.querySelector('.maplibregl-ctrl-top-right') || document.body;
      const wrap = document.createElement('div');
      wrap.className = 'maplibregl-ctrl maplibregl-ctrl-group';
      wrap.appendChild(btn);
      corner.appendChild(wrap);
    })();
  </script>
</body>
</html>
